<?xml version="1.0" encoding="UTF-8"?>
<project name="Simkit"
         basedir="."
         default="help" >
	<description>
         Ant build file for the NPS Simkit and associated libraries. Third
         party jar files are not compiled from source here, but they are copied as
         necessary for the simkit distribution.  This buildfile was created and tested
         using Ant version 1.5.1 on the Mac OSX 10.3 platform, where it works from the
         command line as well as within the NetBeans IDE from Sun Microsystems. Suggestions
         and comments are welcome.
         
         It has also been tested on Linux with NetBeans 3.5.1 and JDK_1.4.2
        </description>
	
<!-- magic properties, do not change or delete -->

	<property name="build.compiler" value="modern"/>
	
<!-- CVS properties (this file) -->
	<property name="CVSId"
              value="$Id$" />

<!-- Project directories             -->

	<property name="dir.src"
	          location="."
	          description="Root of the Simkit source tree." />
	
	<property name="dir.build"
	          location="${basedir}/build"
	          description="Root of the Simkit binary tree." />
	          
	<property name="dir.build.lib"
	          location="${dir.build}/lib"
	          description="Directory for built and copied jar files that will wind up in dir.dist." />
	          
	<property name="dir.dist"
	          location="${basedir}/dist"
	          description="Where the distribution files wind up." />
	          
	<property name="dir.lib"
	          location="${basedir}/lib"
	          description="Location of Simkit's dependencies" />
	          
	<property name="dir.lib.xml"
	          location="${dir.lib}/jwsdp-1.3"
	          description="Where all the XML extensions are." />
	          
	<property name="dir.build.classes"
	          location="${dir.build}/classes"
	          description="Location of class files resulting from operations of this build file." />
	          
	<property name="dir.build.doc"
	          location="${dir.build}/doc"
	          description="Root of the javadoc tree for Simkit." />
                  
        <property name="dir.src.simtran"
                  location="${dir.src}/simkit/xsd/bindings"
                  description="Generated JAXB bindings for Simtran" />
                  
        <property name="dir.src.simasm"
                  location="${dir.src}/simkit/xsd/bindings/assembly"
                  description="Generated JAXB bindings for Simasm" />
                  
        <property name="dir.src.simasm.util"
                  location="${dir.src}/simkit/xsd/assembly"
                  description="Simasm utility" />
                  
        <property name="dir.src.simtran.util"
                  location="${dir.src}/simkit/xsd/translator"
                  description="Simtran utility" />             

<!--  === TARGET: help === -->
	<target name="help">
		<echo message="This is the Ant build file for the NPS Simkit and associated libraries. Third-party jar files are not compiled from source here, but they are copied as necessary for the simkit distribution.  This buildfile was created and tested using Ant version 1.5.1 on the Mac OSX 10.3 platform, where it works from the command line as well as within the NetBeans IDE version 3.5.1 from Sun Microsystems. Suggestions and comments should be forwarded to Kirk Stork (kirk@kastork.org), or posted on the Simkit discussion boards at http://diana.nps.navy.mil/simkit.  Work on integrating Ant and this buildfile within Apple's XCode IDE is in progress." />
    </target>

<!--  === TARGET: init === -->
	<target name="init"
	        description="Preparatory actions required for all targets.">
	    <tstamp />
		<echo message="Build started on ${DSTAMP} at ${TSTAMP}"/>
		<echo message="Buildfile version ${CVSId}"/>
		<echo message="Base directory: ${basedir}" />
		<echo message="Source directory: ${dir.src}" />
		<echo message="Build directory: ${dir.build}" />
	</target>
	
<!--  === TARGET: build.init === -->
	<target name="build.init"
	        depends="init"
	        description="Preparatory actions for compilation and documentation targets">
		<mkdir dir="${dir.build}" />
		<mkdir dir="${dir.build.lib}" />
		<mkdir dir="${dir.build.classes}" />
                <mkdir dir="${dir.build.doc}" />
                <mkdir dir="${dir.src.simtran}" />
                <mkdir dir="${dir.src.simasm}" />
	</target>
	
<!--  === TARGET: clean === -->
    <target name="clean"
            depends="init"
            description="Deletes build directory, javadoc directory and dist directory" >
        <delete dir="${dir.src.simtran}" />
        <delete dir="${dir.src.simasm}" />
        <delete dir="${dir.build}" />
        <delete dir="${dir.dist}" />
    </target>

<!--  === TARGET: compile === -->
    <target name="compile.noextensions"
            depends="build.init"
            description="Compile the Simkit classes and copy resource files to the binary tree.">
        <javac destdir="${dir.build.classes}"
               excludes="viskit/**, xsd/**">
        	<classpath>
        		<pathelement location="${dir.lib}/bsh-2.0b1.jar" />
        		<pathelement location="${dir.lib}/jdom.jar" />
        		<pathelement location="${dir.lib}/jgraph.jar" />
        		<pathelement location="${dir.lib.xml}/dom.jar" />
        		<pathelement location="${dir.lib.xml}/jax-qname.jar" />
        		<pathelement location="${dir.lib.xml}/jaxb-api.jar" />
        		<pathelement location="${dir.lib.xml}/jaxb-impl.jar" />
        		<pathelement location="${dir.lib.xml}/jaxb-libs.jar" />
        		<pathelement location="${dir.lib.xml}/jaxb-xjc.jar" />
        		<pathelement location="${dir.lib.xml}/jaxp-api.jar" />
        		<pathelement location="${dir.lib.xml}/namespace.jar" />
        		<pathelement location="${dir.lib.xml}/relaxngDatatype.jar" />
        		<pathelement location="${dir.lib.xml}/sax.jar" />
        		<pathelement location="${dir.lib.xml}/xalan.jar" />
        		<pathelement location="${dir.lib.xml}/xercesImpl.jar" />
        		<pathelement location="${dir.lib.xml}/xslt.jar" />
        	</classpath>
        	<src path="${dir.src}/simkit"/>
        	<src path="${dir.src}/graph"/>
        </javac>
        
        <copy todir="${dir.build.classes}">
            <fileset dir="${dir.src}">
            	<include name="**/*.txt" />
            	<include name="**/*.png" />
            	<include name="**/*.gif" />
            	<include name="**/*.jpg" />
        		<include name="*.txt" />
        		<exclude name="build/" />
        	</fileset>
        </copy>
    </target>
    
   <!-- compile  -->
  
    <target name="compile"
               depends="compile.noextensions, dep.NPSActions, compile.simxml.util">
        <javac destdir="${dir.build.classes}"
               excludes="xsd/**">
        	<classpath>
        		<pathelement location="${dir.lib}/bsh-2.0b1.jar" />
        		<pathelement location="${dir.lib}/jdom.jar" />
        		<pathelement location="${dir.lib}/jgraph.jar" />
        		<pathelement location="${dir.lib.xml}/dom.jar" />
        		<pathelement location="${dir.lib.xml}/jax-qname.jar" />
        		<pathelement location="${dir.lib.xml}/jaxb-api.jar" />
        		<pathelement location="${dir.lib.xml}/jaxb-impl.jar" />
        		<pathelement location="${dir.lib.xml}/jaxb-libs.jar" />
        		<pathelement location="${dir.lib.xml}/jaxb-xjc.jar" />
        		<pathelement location="${dir.lib.xml}/jaxp-api.jar" />
        		<pathelement location="${dir.lib.xml}/namespace.jar" />
        		<pathelement location="${dir.lib.xml}/relaxngDatatype.jar" />
        		<pathelement location="${dir.lib.xml}/sax.jar" />
        		<pathelement location="${dir.lib.xml}/xalan.jar" />
        		<pathelement location="${dir.lib.xml}/xercesImpl.jar" />
        		<pathelement location="${dir.lib.xml}/xslt.jar" />
<!--        		<pathelement location="../Actions/build/classes/" /> -->
        		<pathelement location="${dir.lib}/npsactions.jar" />
        		<pathelement location="${dir.build.classes}" />
        	</classpath>
        	<src path="${dir.src}/simkit/viskit/"/>
        </javac>
	</target>
<!--  === TARGET: jar === -->
    <target name="jar"
            depends="compile" >
        <jar basedir="${dir.build.classes}"
             compress="false"
             excludes="*/test/*"
             jarfile="${dir.build.lib}/simkit.jar"/>
    </target>

<!--  === TARGET: doc === -->
    <target name="doc"
            depends="build.init"
            description="Create the javadoc for Simkit." >
        
        <javadoc access="private"
                 author="true"
                 destdir="${dir.build.doc}"
                 excludepackagenames="*.test.*"
                 sourcepath="${dir.src}"
                 version="true">
        	<classpath>
        		<pathelement location="${dir.lib}/bsh-2.0b1.jar" />
        		<pathelement location="${dir.lib}/jdom.jar" />
        		<pathelement location="${dir.lib}/jgraph.jar" />
        		<pathelement location="${dir.lib.xml}/dom.jar" />
        		<pathelement location="${dir.lib.xml}/jax-qname.jar" />
        		<pathelement location="${dir.lib.xml}/jaxb-api.jar" />
        		<pathelement location="${dir.lib.xml}/jaxb-impl.jar" />
        		<pathelement location="${dir.lib.xml}/jaxb-libs.jar" />
        		<pathelement location="${dir.lib.xml}/jaxb-xjc.jar" />
        		<pathelement location="${dir.lib.xml}/jaxp-api.jar" />
        		<pathelement location="${dir.lib.xml}/namespace.jar" />
        		<pathelement location="${dir.lib.xml}/relaxngDatatype.jar" />
        		<pathelement location="${dir.lib.xml}/sax.jar" />
        		<pathelement location="${dir.lib.xml}/xalan.jar" />
        		<pathelement location="${dir.lib.xml}/xercesImpl.jar" />
        		<pathelement location="${dir.lib.xml}/xslt.jar" />
        		<pathelement location="../Actions/build/classes/" />
        	</classpath>
            
            <package name="simkit"/>
            <package name="simkit.data"/>
            <package name="simkit.examples" />
            <package name="simkit.nss" />
            <package name="simkit.random"/>
            <package name="simkit.smd"/>
            <package name="simkit.smdx"/>
            <package name="simkit.stat"/>
            <package name="simkit.util"/>
            <package name="simkit.viskit" />
        </javadoc>
    </target>
    
<!-- === TARGET: dist === -->

	<target name="dist"
	        depends="jar, doc">
	    <mkdir dir="${dir.dist}" />
	    <mkdir dir="${dir.dist}/doc" />
		<copy todir="${dir.dist}">
			<fileset dir="${dir.build.lib}" />
			<fileset dir="../Actions/build/lib/" />
		</copy>
		<copy todir="${dir.dist}/doc">
			<fileset dir="${dir.build.doc}" />
		</copy>
	</target>
	
<!-- === NPS Dependencies (Actions, AgentKit, etc.) === -->
<!-- This section calls the Ant build files for the projects referred to. -->

	<target name="dep.NPSActions"
	        depends="build.init"
	        description="Builds the Actions and related packages and puts them into our lib directory.">
		<echo message="Building Actions and related packages" />
		<ant antfile="build.xml"
		     dir="../Actions"
		     target="jar"
		     inheritAll="false" />
		<copy todir="${dir.lib}">
			<fileset dir="../Actions/build/lib/" />
		</copy>
	</target>
	
	<target name="NPSAgentKit">
	</target>
        
        <taskdef name="xjc" classname="com.sun.tools.xjc.XJCTask" >
             <classpath>
                 <fileset dir="${dir.lib.xml}" includes="*.jar" />
             </classpath>
        </taskdef>
        
        <taskdef name="trang" classname="net.amadan.trang.ant.TrangTask" >
             <classpath>
                 <fileset dir="${dir.lib}" includes="trang*.jar" />
             </classpath>
        </taskdef>       
        <target name="bindings.simkit"
                depends="build.schema"
                description="Create bindings to the simkit XML Schema" >
            
            <xjc target="${dir.src}"
                package="simkit.xsd.bindings"
                schema="${dir.src.simtran.util}/simkit.xsd" />
              
            <xjc target="${dir.src}"
                extension="true"
                package="simkit.xsd.bindings.assembly"
                schema="${dir.src.simasm.util}/assembly.xsd" />
        </target>
        
        <target name="build.schema"
                depends="build.init"
                description="Create xsd Schemas from dtd" >

            <trang
                failonerror="true"
                input="${dir.src.simtran.util}/simkit.dtd"
                output="${dir.src.simtran.util}/simkit.xsd"
                schemaIn="dtd"
                schemaOut="xsd" />
                
            <trang
                failonerror="true"
                input="${dir.src.simasm.util}/assembly.dtd"
                output="${dir.src.simasm.util}/assembly.xsd"
                schemaIn="dtd"
                schemaOut="xsd" />
        </target>
        
        <target name="compile.bindings"
                depends="bindings.simkit"
                description="Build bindings to Schemas" >
            <javac destdir="${dir.build.classes}" >
        	<classpath>
        		<fileset dir="${dir.lib.xml}" includes="*.jar" />
        	</classpath>
                <src path="${dir.src.simtran}"/>
            </javac>
            <copy todir="${dir.build.classes}/simkit/xsd/bindings" >
                <fileset dir="${dir.src}/simkit/xsd/bindings" includes="jaxb.properties" />
                <fileset dir="${dir.src}/simkit/xsd/bindings" includes="bgm.ser" />
            </copy>
            <javac destdir="${dir.build.classes}" >
        	<classpath>
        		<fileset dir="${dir.lib.xml}" includes="*.jar" />
        	</classpath>
        	<src path="${dir.src.simasm}"/>
            </javac>    
            <copy todir="${dir.build.classes}/simkit/xsd/bindings/assembly" >
                <fileset dir="${dir.src}/simkit/xsd/bindings/assembly" includes="jaxb.properties" />
                <fileset dir="${dir.src}/simkit/xsd/bindings/assembly" includes="bgm.ser" />
            </copy>
            
        </target>
        
        <target name="compile.simxml.util"
                depends="compile.bindings"
                description="Build xml2java utils" >
            <javac destdir="${dir.build.classes}" >
                <classpath>
                    <fileset dir="${dir.build.classes}" />
                </classpath>
                <src path="${dir.src.simtran.util}" />
            </javac>    
            <javac destdir="${dir.build.classes}" >
                <classpath>
                    <fileset dir="${dir.build.classes}" />
                </classpath>
                <src path="${dir.src.simasm.util}" />
                <!-- tbd remove include and exclude, bug in output from simasm tbd -->
                <include name="SimkitAssemblyXML2Java.java"/>
                <exclude name="Server*.java"/>
            </javac>
        </target>   
</project>
